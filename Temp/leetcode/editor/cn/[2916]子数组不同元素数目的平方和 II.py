# 2916 å­æ•°ç»„ä¸åŒå…ƒç´ æ•°ç›®çš„å¹³æ–¹å’Œ II
from typing import *
from collections import *
from itertools import *
from functools import *
from math import *
import heapq

# leetcode submit region begin(Prohibit modification and deletion)
"""
å‰é¢å‚è€ƒ[2262]å­—ç¬¦ä¸²æ€»å¼•åŠ›
nums = [1,2,2,3,1]
ä»å·¦å¾€å³éå†æ•´ä¸ªæ•°ç»„
ä»¥å½“å‰è¿™ä¸ªæ•°å­—ä¸ºå¼€å¤´åˆ°å½“å‰éå†åˆ°çš„æ•°å­—ä¸ºç»“å°¾çš„è¿™ä¸ªå­ä¸²æœ‰å¤šå°‘ä¸ªä¸åŒçš„æ•°å­—^2     ans=å¹³æ–¹å’Œ
a
1           ans1 
a   b       
2^2 1^2         ans2 
a   b   b
2^2 1^2 1^2       ans3 
a   b   b   c
3^2 2^2 2^2 1^2     ans4 
a   b   b   c   a
3^2 3^2 3^2 2^2 1^2   ans5 
è§„å¾‹ï¼ˆæ€»ç»“ï¼‰
ans5 - ans4 = 3^2-2^2 + 3^2-2^2 + 2^2-1^2 + 1^2-0^2
            = 2*2+1 + 2*2+1 + 2*1+1 + 2*0+1
            = 2(2+2+1)+4
==========================================================================================
è®¾ç¬¬ i ä¸ªæ•°å­—ä¸Šä¸€æ¬¡å‡ºç°çš„ä½ç½®æ˜¯ j
nums[0..i-1] çš„ä¸åŒè®¡æ•° x[0]
nums[1..i-1] çš„ä¸åŒè®¡æ•° x[1]
nums[j..i-1] çš„ä¸åŒè®¡æ•° x[j]
nums[i-1..i-1] çš„ä¸åŒè®¡æ•° x[i-1]
x[i]=0
åŠ å…¥ nums[i] ä¹‹åï¼Œx[0] åˆ° x[j] ä¸å˜ï¼Œ x[j+1] åˆ° x[i] éƒ½åŠ 1
æ‰€æœ‰ä¸åŒè®¡æ•°çš„å¹³æ–¹å’Œçš„å¢é‡ = (x[j+1]+1)^2-x[j+1]^2 + (x[j+2]+1)^2-x[j+2]^2 + .. + (x[i]+1)^2-x[i]^2
                      = 2*x[j+1]+1 + 2*x[j+2]+1 + ... + 2*x[i]+1
                      = 2sum(x[j+1 .. i]) + (i-j)
==========================================================================================
1.æ¯ä¸€æ¬¡æ“ä½œéƒ½æ˜¯å¯¹ä¸€ä¸ªåŒºé—´å†…çš„å€¼+1 ï¼ˆx[j+1] åˆ° x[i] éƒ½åŠ 1ï¼‰
2.æ¯ä¸€æ¬¡æŸ¥è¯¢éƒ½æ˜¯è¿”å›ä¸€ä¸ªåŒºé—´çš„å’Œ   ï¼ˆsum(x[j+1 .. i])ï¼‰
å› æ­¤ï¼Œç”¨çº¿æ®µæ ‘ã€‚
â€œæ¯ä¸€æ¬¡â€å°±æ˜¯å¾€åéå†ï¼Œæ–°åŠ å…¥ä¸€ä¸ªæ•°ã€‚
æ“ä½œå’ŒæŸ¥è¯¢çš„æ˜¯åŒä¸€ä¸ªåŒºé—´ã€‚
è¦ç»´æŠ¤çš„ sum[o] åˆå§‹å…¨ä¸º0ï¼Œä¸éœ€è¦buildäº†
æ¯ä¸€æ¬¡ æŸ¥è¯¢/æ“ä½œ ï¼š
1. è¿”å› sum(x[j+1 .. i]
2. æ›´æ–° x[j+1 ... i]
    =>
3. ç»´æŠ¤ sum(x[j+1 .. i]
"""


class Solution:
    def sumCounts(self, nums: List[int]) -> int:
        MOD = 10 ** 9 + 7
        n = len(nums)
        sum = [0] * (4 * n)
        todo = [0] * (4 * n)  # å¯¹åŒºé—´å†…çš„æ¯ä¸€ä¸ªå€¼ï¼ˆx[i]ï¼‰è¦å¢åŠ å¤šå°‘

        def do(o: int, l: int, r: int, add: int) -> None:
            """
            addæ¥è‡ªäºï¼š
            1. query_and_add é€’å½’ç»“æŸæ—¶ï¼Œå¯¹ x[l...r] éƒ½+1
            2. ä»çˆ¶èŠ‚ç‚¹ä¼ é€’è¿‡æ¥çš„ todo[o]ï¼Œå¯¹ x[l...r] éƒ½+add
            è¡¨ç¤º x[l...r] åŠ ä¸Šå¤šå°‘
            =ã€‹ sum[o] += åŒºé—´é•¿åº¦ * add

            todo[o]è¡¨ç¤º
            èŠ‚ç‚¹ o è¿™ä¸ªåŒºé—´ç´¯åŠ äº†å¤šå°‘ï¼Œæ˜¯ä¸€ä¸ªæ ‡è®°/è®°å½•çš„ä½œç”¨ï¼Œä¸»è¦æ˜¯å‘ä¸‹ä¼ é€’çš„æ—¶å€™ä¼šç”¨åˆ°
            """
            sum[o] += (r - l + 1) * add
            todo[o] += add

        def query_and_add(o: int, l: int, r: int, L: int, R: int) -> int:
            """
            l,rï¼šå½“å‰èŠ‚ç‚¹ä»£è¡¨çš„åŒºé—´
            L,Rï¼šè¦æŸ¥è¯¢/æ›´æ–°çš„åŒºé—´
            è¿”å›ï¼šè¦æŸ¥è¯¢çš„åŒºé—´çš„ sum(x[l...r])
            å½“ [l,r] âŠ‚ [L,R]ï¼Œè¿”å› sum(x[l...r]) å³ sum[o]ï¼Œå¹¶ç»“æŸé€’å½’
            å› ä¸º sum(x[l...r]) ä¼šç”±å¥½å¤šâ€œç‰¹æ®ŠåŒºé—´â€ç»„æˆï¼Œè¦é€’å½’å·¦å³å­©å­ï¼Œæ‰€ä»¥ï¼Œres è¦ +=
            """
            if L <= l and r <= R:
                res = sum[o]
                do(o, l, r, 1)  # x[l...r]éƒ½è¦åŠ 1
                return res
            m = (l + r) // 2
            if todo[o]:  # å‘ä¸‹ä¼ é€’
                do(o * 2, l, m, todo[o])
                do(o * 2 + 1, m + 1, r, todo[o])
                todo[o] = 0
            res = 0
            if m >= L:
                res += query_and_add(o * 2, l, m, L, R)
            if m < R:  # m+1<=R
                res += query_and_add(o * 2 + 1, m + 1, r, L, R)
            # ç»´æŠ¤ sum[o]
            sum[o] = sum[o * 2] + sum[o * 2 + 1]
            return res

        last = {}
        ans = s = 0
        for i, x in enumerate(nums, 1):  # èµ·å§‹ç´¢å¼•è®¾ä¸º1
            j = last.get(x, 0)
            # è¦æŸ¥è¯¢çš„èŒƒå›´æ˜¯[j+1,i]
            delta = query_and_add(1, 1, n, j + 1, i) * 2 + i - j  # å¹³æ–¹å’Œçš„å¢é‡
            s += delta  # åˆ°xçš„å¹³æ–¹å’Œ
            ans = (ans + s) % MOD
            last[x] = i
        return ans
# leetcode submit region end(Prohibit modification and deletion)


# ç»™ä½ ä¸€ä¸ªä¸‹æ ‡ä» 0 å¼€å§‹çš„æ•´æ•°æ•°ç»„ nums ã€‚ 
# 
#  å®šä¹‰ nums ä¸€ä¸ªå­æ•°ç»„çš„ ä¸åŒè®¡æ•° å€¼å¦‚ä¸‹ï¼š 
# 
#  
#  ä»¤ nums[i..j] è¡¨ç¤º nums ä¸­æ‰€æœ‰ä¸‹æ ‡åœ¨ i åˆ° j èŒƒå›´å†…çš„å…ƒç´ æ„æˆçš„å­æ•°ç»„ï¼ˆæ»¡è¶³ 0 <= i <= j < nums.length ï¼‰
# ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°å­æ•°ç»„ nums[i..j] ä¸­ä¸åŒå€¼çš„æ•°ç›®ä¸º nums[i..j] çš„ä¸åŒè®¡æ•°ã€‚ 
#  
# 
#  è¯·ä½ è¿”å› nums ä¸­æ‰€æœ‰å­æ•°ç»„çš„ ä¸åŒè®¡æ•° çš„ å¹³æ–¹ å’Œã€‚ 
# 
#  ç”±äºç­”æ¡ˆå¯èƒ½ä¼šå¾ˆå¤§ï¼Œè¯·ä½ å°†å®ƒå¯¹ 10â¹ + 7 å–ä½™ åè¿”å›ã€‚ 
# 
#  å­æ•°ç»„æŒ‡çš„æ˜¯ä¸€ä¸ªæ•°ç»„é‡Œé¢ä¸€æ®µè¿ç»­ éç©º çš„å…ƒç´ åºåˆ—ã€‚ 
# 
#  
# 
#  ç¤ºä¾‹ 1ï¼š 
# 
#  
# è¾“å…¥ï¼šnums = [1,2,1]
# è¾“å‡ºï¼š15
# è§£é‡Šï¼šå…­ä¸ªå­æ•°ç»„åˆ†åˆ«ä¸ºï¼š
# [1]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [1]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [1,2]: 2 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [2,1]: 2 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [1,2,1]: 2 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# æ‰€æœ‰ä¸åŒè®¡æ•°çš„å¹³æ–¹å’Œä¸º 1Â² + 1Â² + 1Â² + 2Â² + 2Â² + 2Â² = 15 ã€‚
#  
# 
#  ç¤ºä¾‹ 2ï¼š 
# 
#  
# è¾“å…¥ï¼šnums = [2,2]
# è¾“å‡ºï¼š3
# è§£é‡Šï¼šä¸‰ä¸ªå­æ•°ç»„åˆ†åˆ«ä¸ºï¼š
# [2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# [2,2]: 1 ä¸ªäº’ä¸ç›¸åŒçš„å…ƒç´ ã€‚
# æ‰€æœ‰ä¸åŒè®¡æ•°çš„å¹³æ–¹å’Œä¸º 1Â² + 1Â² + 1Â² = 3 ã€‚
#  
# 
#  
# 
#  æç¤ºï¼š 
# 
#  
#  1 <= nums.length <= 10âµ 
#  1 <= nums[i] <= 10âµ 
#  
# 
#  Related Topics æ ‘çŠ¶æ•°ç»„ çº¿æ®µæ ‘ æ•°ç»„ åŠ¨æ€è§„åˆ’ ğŸ‘ 8 ğŸ‘ 0
